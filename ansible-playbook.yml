---
- name: Setup Complete Development Environment for Android Terminal
  hosts: localhost
  become: yes
  gather_facts: yes
  
  vars:
    ssh_port: 2222
    ssh_config_file: /etc/ssh/sshd_config
    ssh_backup_file: /etc/ssh/sshd_config.backup
    ssh_log_file: /var/log/ssh.log
    ssh_startup_script: /usr/local/bin/start-ssh.sh
    systemd_service_file: /etc/systemd/system/android-ssh.service
    
    # Kubernetes/Minikube settings
    kubectl_version: "1.29.0"
    
    # User settings
    # User settings
    setup_user: "{{ ansible_env.USER | default('root') }}"
    setup_user_home: "{{ ansible_env.HOME | default('/root') }}"

    # Architecture mapping
    arch_map:
      x86_64: "amd64"
      aarch64: "arm64"
    
  pre_tasks:
    - name: Display system information
      debug:
        msg: |
          ========================================
          System Information
          ========================================
          System: {{ ansible_system }}
          Distribution: {{ ansible_distribution }}
          Version: {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}
          Mapped Arch: {{ arch_map[ansible_architecture] | default('amd64') }}
          Kernel: {{ ansible_kernel }}
          ========================================
      
    - name: Check if running on Debian-based system
      fail:
        msg: "This playbook is designed for Debian-based systems only (including Android Terminal)"
      when: ansible_distribution not in ["Debian", "Ubuntu"]
        
    - name: Ensure required packages are installed
      apt:
        name:
          - openssh-server
          - curl
          - net-tools
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - software-properties-common
          - wget
          - unzip
          - jq
        state: present
        update_cache: yes
      
  tasks:
    # SSH Setup Tasks
    - name: Backup existing SSH configuration
      copy:
        src: "{{ ssh_config_file }}"
        dest: "{{ ssh_backup_file }}"
        remote_src: yes
        backup: yes
      ignore_errors: yes
      
    - name: Generate random password for root user
      set_fact:
        root_password: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits') }}"
        
    - name: Set root password
      user:
        name: root
        password: "{{ root_password | password_hash('sha512') }}"
        
    - name: Create hardened SSH configuration
      template:
        src: sshd_config.j2
        dest: "{{ ssh_config_file }}"
        owner: root
        group: root
        mode: '0600'
        backup: yes
      notify: restart ssh
        
    - name: Create SSH startup script
      template:
        src: start-ssh.sh.j2
        dest: "{{ ssh_startup_script }}"
        owner: root
        group: root
        mode: '0755'
        
    - name: Create systemd service file (if systemd is available)
      template:
        src: android-ssh.service.j2
        dest: "{{ systemd_service_file }}"
        owner: root
        group: root
        mode: '0644'
      when: ansible_service_mgr == "systemd"
      notify: reload systemd
      
    - name: Create SSH log file
      file:
        path: "{{ ssh_log_file }}"
        state: touch
        owner: root
        group: root
        mode: '0644'
        
    - name: Ensure SSH directories have correct permissions
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /etc/ssh
        - /var/run/sshd
        - /usr/local/bin
        
    - name: Install update-android-env command
      copy:
        src: "{{ playbook_dir }}/install-ansible.sh"
        dest: /usr/local/bin/update-android-env
        owner: root
        group: root
        mode: '0755'
        
    # Podman Installation
    - name: Install Podman
      apt:
        name:
          - podman
          - buildah
          - skopeo
        state: present
        update_cache: yes
      
    # Sway / GUI Installation
    - name: Install Sway and GUI tools
      apt:
        name:
          - sway
          - swaybg
          - swayidle
          - swaylock
          - waybar
          - foot
          - wofi
          - kanshi
          - grim
          - slurp
          - wl-clipboard
          - squeekboard
          - xwayland
          - fonts-font-awesome
          - seatd
          - dbus-x11
        state: present
        update_cache: yes

    - name: Ensure seat group exists
      group:
        name: seat
        state: present
        system: yes

    - name: Add user to hardware groups
      user:
        name: "{{ setup_user }}"
        groups: video,input,tty,render,seat
        append: yes
        
    - name: Enable seatd service (if systemd)
      systemd:
        name: seatd
        state: started
        enabled: yes
      when: ansible_service_mgr == "systemd"
      ignore_errors: yes

    - name: Enable dbus service
      service:
        name: dbus
        state: started
        enabled: yes
      ignore_errors: yes

    - name: Configure Environment setup script (XDG + DBus)
      copy:
        dest: /etc/profile.d/00-environment.sh
        content: |
          # XDG Runtime Dir - Critical for Wayland
          if [ -z "$XDG_RUNTIME_DIR" ] && [ -n "$USER" ]; then
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            if [ ! -d "$XDG_RUNTIME_DIR" ]; then
              mkdir -p "$XDG_RUNTIME_DIR"
              chmod 700 "$XDG_RUNTIME_DIR"
              chown "$USER:$USER" "$XDG_RUNTIME_DIR"
            fi
          fi
          
          # DBus Session - Critical for IPC (Waybar/Sway interactions)
          if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
             # Try using existing session if available
             if [ -e "$XDG_RUNTIME_DIR/bus" ]; then
                export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
             elif command -v dbus-launch >/dev/null; then
                # Fallback to launching a new session
                eval $(dbus-launch --sh-syntax --exit-with-session)
             fi
          fi
          
          # Sway/Wayland Compatibility for Android Containers
          export WLR_RENDERER=pixman          # Force software rendering (fixes black screen/gl errors)
          export WLR_NO_HARDWARE_CURSORS=1    # Fix invisible cursor
          export WLR_LIBINPUT_NO_DEVICES=1    # Fix mouse not working (relies on X11/Wayland backend input)
          export XDG_CURRENT_DESKTOP=sway     # Help apps know where they are
          export XDG_SESSION_TYPE=wayland
          export MOZ_ENABLE_WAYLAND=1
          export QT_QPA_PLATFORM=wayland
        mode: '0755'

    - name: Ensure Sway configuration directory exists
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ setup_user }}"
        group: "{{ setup_user }}"
        mode: '0755'
      loop:
        - "{{ setup_user_home }}/.config/sway"
        - "{{ setup_user_home }}/.config/waybar"
        - "{{ setup_user_home }}/.config/kanshi"
        - "{{ setup_user_home }}/.config/foot"

    - name: Deploy Sway configuration
      template:
        src: sway/config.j2
        dest: "{{ setup_user_home }}/.config/sway/config"
        owner: "{{ setup_user }}"
        group: "{{ setup_user }}"
        mode: '0644'

    - name: Deploy Waybar configuration
      template:
        src: waybar/config.j2
        dest: "{{ setup_user_home }}/.config/waybar/config"
        owner: "{{ setup_user }}"
        group: "{{ setup_user }}"
        mode: '0644'

    - name: Deploy Kanshi configuration
      template:
        src: sway/kanshi.config.j2
        dest: "{{ setup_user_home }}/.config/kanshi/config"
        owner: "{{ setup_user }}"
        group: "{{ setup_user }}"
        mode: '0644'
      
    # Kubectl Installation
    - name: Download kubectl
      get_url:
        url: "https://dl.k8s.io/release/v{{ kubectl_version }}/bin/linux/{{ arch_map[ansible_architecture] | default('amd64') }}/kubectl"
        dest: /usr/local/bin/kubectl
        mode: '0755'
        force: yes
      
    - name: Verify kubectl installation
      command: kubectl version --client
      register: kubectl_version_output

    - name: Get device IP address
      set_fact:
        device_ip: "{{ ansible_default_ipv4.address }}"
        
    - name: Display network information
      debug:
        msg: |
          ========================================
          Network Information
          ========================================
          Primary Interface: {{ ansible_default_ipv4.interface }}
          Container IP: {{ ansible_default_ipv4.address }}
          Container Network: {{ ansible_default_ipv4.network }}
          
          All Network Interfaces:
          {% for interface in ansible_interfaces %}
          {% if hostvars[inventory_hostname]['ansible_' + interface.replace('-', '_')] is defined %}
          {% if hostvars[inventory_hostname]['ansible_' + interface.replace('-', '_')]['ipv4'] is defined %}
          - {{ interface }}: {{ hostvars[inventory_hostname]['ansible_' + interface.replace('-', '_')]['ipv4']['address'] }}
          {% endif %}
          {% endif %}
          {% endfor %}
          
          Note: Your Android Terminal uses a virtual network interface (like enp0s8).
          Use port forwarding for reliable external access:
          adb forward tcp:2222 tcp:2222
          ========================================
         
    - name: Display installation summary
      debug:
        msg: |
          ========================================
          Complete Development Environment Setup Complete!
          ========================================
          
          ğŸ“± Device IP: {{ device_ip }}
          ğŸ”‘ Root Password: {{ root_password }}
          ğŸšª SSH Port: {{ ssh_port }}
          
          ğŸ³ Podman: Installed
          â˜¸ï¸  Kubectl: Installed (Client only)
          
          ğŸš€ To start SSH server:
          - Interactive: {{ ssh_startup_script }}
          - Background: nohup {{ ssh_startup_script }} > {{ ssh_log_file }} 2>&1 &
          - Systemd: systemctl start android-ssh (if available)
          
          ğŸ”— Connect from another device:
          ssh root@{{ device_ip }} -p {{ ssh_port }}
          
          ğŸ“‹ Logs: {{ ssh_log_file }}
          âš™ï¸  Config: {{ ssh_config_file }}
          
          â˜¸ï¸  Kubernetes Access:
          - kubectl: kubectl get pods --all-namespaces (Requires external cluster config)
          
          âš ï¸  IMPORTANT: Change the root password after first login!
          ========================================
          
  handlers:
    - name: restart ssh
      service:
        name: ssh
        state: restarted
      ignore_errors: yes
        
    - name: reload systemd
      systemd:
        daemon_reload: yes
      when: ansible_service_mgr == "systemd"
